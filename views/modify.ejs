<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Editing Page</title>
    <link rel="stylesheet" href="/main.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>

    
</head>
<body>

    <div class="container">
        
        <div class="post">
            <% if (locals.post) { %>
                <h1>
                    <%=heading%>
                </h1>
                <form id="editForm" method="post" action="/posts/<%=post.id%>">
                    <div class="mb-3">
                        <label for="formFileMultiple" class="form-label">Multiple files input example</label>
                        <input class="form-control" type="file" id="formFileMultiple" name="image[]" value = "" multiple accept="image/*,application/pdf,.doc,.docx">
                        <div id="frames"></div>
                    </div>
                    <textarea name="content" rows="10"><%=post.content %></textarea>
    
                    <button class="full-width" type="submit">
                        <%= submit %>
                    </button>
                </form>
                <% } else { %>
                    <h1>
                        <%=heading%>
                    </h1>
                    <form id="newPostForm">
                        <div class="mb-3">
                            <label for="formFileMultiple" class="form-label">Multiple files input example</label>
                            <input class="form-control" type="file" id="formFileMultiple" name="image[]" multiple accept="image/*,application/pdf,.doc,.docx">
                            <div id="frames"></div>
                        </div>
    
                        <textarea name="content" id="content" placeholder="Content" required rows="10"></textarea>
                        
                        <button class="full-width" id="insert" type="submit"><%= submit %></button>
                    </form>
                    <% } %>
        </div>
    </div>
    

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
        import {
            getStorage,
            ref as storageRef,
            getDownloadURL,
            uploadBytes,
        } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-storage.js";
        import {
            getDatabase,
            ref,
            set,
        } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-database.js";

        import firebaseConfig from "/js/firebase.js";
        

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const storage = getStorage(app);

        document.addEventListener('DOMContentLoaded', () => {
                console.log("DOM fully loaded and parsed");

                const insertButton = document.getElementById("newPostForm");
                insertButton.addEventListener("submit", async (event) => {
                    console.log("Clicked");
                    event.preventDefault();

                    const content = document.getElementById("content").value;
                    const files = document.getElementById("formFileMultiple").files;

                    const fileUrls = [];
                    const uploadPromises = [];

                    for (let file of files) {
                        uploadPromises.push(uploadFile(file).then((url) => {
                            if (url) fileUrls.push(url);
                        }));
                    }

                    try {
                        await Promise.all(uploadPromises);

                        const newPostRef = ref(db, "posts/" + Date.now());
                        await set(newPostRef, {
                            content: content,
                            files: fileUrls,
                        });

                        console.log("Data entered successfully!");
                        window.location.href = '/admin';
                    } catch (error) {
                        console.error("Error uploading files or saving data:", error);
                    }
                });

                $('#formFileMultiple').change(function () {
                    $("#frames").html('');
                    for (var i = 0; i < $(this)[0].files.length; i++) {
                        const file = this.files[i];
                        const fileType = file.type;

                        // Create a container div for each preview
                        const previewContainer = $('<div class="preview-container"></div>');
                        const deleteButton = $('<button class="delete-btn">&times;</button>');

                        // Preview logic for different file types
                        if (fileType.startsWith('image/')) {
                            const imgURL = window.URL.createObjectURL(file);
                            const imgElement = $('<img src="' + imgURL + '" alt="preview"/>');
                            previewContainer.append(imgElement);
                        } else if (fileType === 'application/pdf') {
                            previewContainer.append('<p>' + file.name + ' (PDF)</p>');
                        } else if (
                            fileType === 'application/msword' ||
                            fileType === 'application/vnd.openxmlformats-officedocument.wordprocessingml.document'
                        ) {
                            previewContainer.append('<p>' + file.name + ' (Word Document)</p>');
                        } else {
                            previewContainer.append('<p>' + file.name + ' (Unsupported Preview)</p>');
                        }

                        // Append delete button to the container
                        previewContainer.append(deleteButton);

                        // Append the container to the frames div
                        $("#frames").append(previewContainer);

                        // Add event listener for the delete button  
                        deleteButton.on('click', function () {
                            previewContainer.remove();
                        });
                    }
                });
            });

            const uploadFile = async (file) => {
                if (file === null) return;
                const fileRef = storageRef(storage, `files/${file.name}`);
                try {
                    const snapshot = await uploadBytes(fileRef, file);
                    const downloadURL = await getDownloadURL(fileRef);
                    console.log("File uploaded successfully!");
                    return downloadURL;
                } catch (error) {
                    console.error("Error uploading file:", error);
                }
            };
    </script>
    
</body>
<%- include("partials/footer.ejs") %>



</html>